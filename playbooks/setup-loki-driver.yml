---
- name: Setup loki driver
  hosts: all, !data*
  vars_files:
    - "../vars/index.yml"
  remote_user: "{{ unix_user }}"

  tasks:
    - name: Install Docker plugin
      community.docker.docker_plugin:
        plugin_name: grafana/loki-docker-driver:latest
        alias: loki
        state: enable

    - name: Copy docker config
      ansible.builtin.copy:
        src: "../configs/daemon.json"
        dest: /etc/docker/daemon.json
        owner: "{{ unix_user }}"
        group: "{{ unix_user }}"
        mode: '0744'
      become: true

    - name: Restart Docker service
      become: true
      ansible.builtin.service:
        name: docker
        state: restarted

