---
- name: setup crontab
  hosts: rs-dba*
  gather_facts: false
  vars_files:
    - "../vars/index.yml"
  remote_user: "{{ username }}"
  vars:
    back_repo: rs-back
    pg2arrow_repo: rs-pg2arrow
    streamer_repo: rs-streamer
    b2f_repo: rs-b2f
    str_priv: "{{ groups['all'] | select('match', '^rs-str') | map('extract', hostvars, ['private_ipv4']) | list | first }}"

  tasks:
    - name: 05 22 * * * /git/{{ back_repo }}/.venv/bin/python3 /git/{{ back_repo }}/app/download_data.py
      ansible.builtin.cron:
        name: "download_data.py"
        minute: "05"
        hour: "22"
        job: "/git/{{ back_repo }}/.venv/bin/python3 /git/{{ back_repo }}/app/download_data.py"

    - name: 00 01 * * * /git/{{ back_repo }}/.venv/bin/python3 /git/{{ back_repo }}/app/download_data.py
      ansible.builtin.cron:
        name: "download_data.py 2"
        minute: "00"
        hour: "01"
        job: "/git/{{ back_repo }}/.venv/bin/python3 /git/{{ back_repo }}/app/download_data.py"

    - name: 15 01 * * * /git/{{ back_repo }}/.venv/bin/python3 /git/{{ back_repo }}/app/merge_data.py
      ansible.builtin.cron:
        name: "merge_data.py"
        minute: "15"
        hour: "01"
        job: "/git/{{ back_repo }}/.venv/bin/python3 /git/{{ back_repo }}/app/merge_data.py"

    - name: 30 06 * * * . /git/{{ back_repo }}/.venv/bin/activate....
      ansible.builtin.cron:
        name: "import_data.py"
        minute: "30"
        hour: "06"
        job: ". /git/{{ back_repo }}/.venv/bin/activate && /git/{{ back_repo }}/.venv/bin/python3 /git/{{ back_repo }}/app/import_data.py && deactivate"

    - name: 30 07 * * * python3 /git/{{ pg2arrow_repo }}/pg2arrow.py
      ansible.builtin.cron:
        name: "pg2arrow.py"
        minute: "30"
        hour: "07"
        job: "python3 /git/{{ pg2arrow_repo }}/pg2arrow.py"

    - name: 45 07 * * * scp -i ~/.ssh/id_rsa /git/{{ pg2arrow_repo }}/*.arrow {{ username }}@{{ str_priv }}:/git/{{ streamer_repo }}/.
      ansible.builtin.cron:
        name: "pg2arrow.py"
        minute: "30"
        hour: "07"
        job: "scp -i ~/.ssh/rsa_id /git/{{ pg2arrow_repo }}/*.arrow {{ username }}@{{ str_priv }}:/git/{{ streamer_repo }}/."

    - name: 00 08 * * * cd /git/{{ b2f_repo }}/ && /home/{{ username }}/.nvm/versions/node/*/bin/ts-node b2fSecs.ts
      ansible.builtin.cron:
        name: "b2fSecs.ts"
        minute: "00"
        hour: "08"
        job: "cd /git/{{ b2f_repo }}/ && /home/{{ username }}/.nvm/versions/node/*/bin/ts-node b2fSecs.ts"
      # 05 22 * * * /git/regshort-back/.venv/bin/python3 /git/regshort-back/app/download_data.py
      # 00 01 * * * /git/regshort-back/.venv/bin/python3 /git/regshort-back/app/download_data.py
      # 15 01 * * * /git/regshort-back/.venv/bin/python3 /git/regshort-back/app/merge_data.py
      # 30 06 * * * . /git/regshort-back/.venv/bin/activate && /git/regshort-back/.venbinv//python3 /git/regshort-back/app/import_data.py && deactivate
      # 30 07 * * * python3 /git/regshort-pg2arrow/pg2arrow.py
      # 45 07 * * * scp -i ~/.ssh/regshort_rsa /git/regshort-pg2arrow/*.arrow regshort@regshort-str:/git/regshort-streamer/.
      # 00 08 * * * cd /git/regshort-b2f/ && /home/regshort/.nvm/versions/node/v18.13.0/bin/ts-node b2fSecs.ts
